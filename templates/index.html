<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}"/>
</head>
<body>
    <h2>Seja bem vindo, <span class="userId">@{{ login }}</span></h2>
    <div id="div_stream">
        {% if not stream %}
            <input onclick="location.href='/stream/criar'" type="button" value="Criar Stream" />
        {% elif not stream.iniciado %}
            <div>
                <input type="text" name="id" value="{{ stream.id }}" readonly/><br>
                <input type="text" name="url" value="{{ stream.url }}" readonly/><br>
                <input type="text" name="key" value="{{ stream.key }}" readonly/><br>
                <input onclick="location.href='/stream/iniciar'"type="button" value="Iniciar Stream" />
            </div>
        {% else %}
            <input type="text" name="id" value="{{ stream.id }}" readonly/><br>
            <input onclick="location.href='/stream/encerrar'" type="button" value="Encerrar Stream" />
        {% endif %}
    </div>
    <div id="comentarios" ></div>
    <script>
        var a=0;

        function mostrarResponder(id){
            var resposta = prompt("Responder");

            if (resposta == null || resposta == "") return;

            $.post({
                url: "/responder/" + id,
                data: "resposta=" + resposta,
                dataType: "json",
                success: function(data){
                    console.log(data);
                }
            });
        }
    </script>
    {% if stream and stream.iniciado %}
    <script>
        var div_comentarios = document.getElementById("comentarios");

        function getComentarios(){
            $.ajax({
                type: "get",
                url: "comentarios",
                dataType: "json",
                success: function(data){
                    while (a < data.length){
                        var comentario = document.createElement("div");
                        comentario.id = data[a].id;
                        
                        var c_id = data[a].id,
                            c_dt_envio = data[a].dt_envio,
                            c_texto = data[a].texto;

                        var u = data[a].usuario,
                            u_id = u.id,
                            u_nome = u.nome,
                            u_img = u.img;
                        
                        var autor = document.createElement("a");
                        autor.id = u_id;
                        autor.className = "userId"
                        autor.innerHTML = "<img src=\"" + u_img + "\" />" + "@" + u_nome;
                        autor.href = "//instagram.com/" + u_nome;

                        var mensagem = document.createElement("p");
                        mensagem.innerHTML = c_texto;

                        var bt_responder = document.createElement("button");
                        bt_responder.innerHTML = "Responder";
                        bt_responder.onclick = function (){
                            mostrarResponder(comentario.id);
                        };

                        console.log("Novo comentario de " + autor.innerHTML + ": " + mensagem.innerHTML);

                        comentario.appendChild(autor);
                        comentario.appendChild(mensagem);
                        comentario.appendChild(bt_responder);
                        div_comentarios.appendChild(comentario);
                        a+=1;
                    }
                }
            });
            
            setTimeout(getComentarios, 2000);
        }

        getComentarios();
    </script>
    {% endif %}
    {% if erro %}
        {% if mensagem %}
            <script>
                alert("Erro: {{ mensagem }}");
            </script>
        {% else %}
            <script>
                alert("Erro: Ocorreu um erro desconhecido!");
            </script>
        {% endif %}
        <script>
            location.href = ".";
        </script>
    {% elif mensagem %}
        <script>
            alert("{{ mensagem }}");
        </script>
        <script>
            location.href = ".";
        </script>
    {% endif %}
</body>
</html>